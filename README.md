## PS4

The Playstation System Package Manager  (in short PS4) is a binary package system
**designed and implemented from scratch**. Its goal is to be fast, easy to use,
bug-free, featureful and portable as much as possible.

The PS4 code is totally **compatible with POSIX/SUSv2/C99 standards**, and
released with a **Simplified BSD license (2 clause)**. There is a well
documented API provided by the PS4 Library that is the basis for its frontends
to handle binary packages and repositories. Some highlights:

 * Supports **multiple local/remote repositories** (HTTP/HTTPS/FTP).
 * **RSA signed remote repositories** (NEW in 0.27).
 * Supports **multiple compression formats** for repositories:
   gzip (zlib), bzip2, lz4, xz, [zstd](https://github.com/facebook/zstd) (default).
 * Supports **multiple compression formats** for package archives:
   gzip (zlib), bzip2, lz4, xz, [zstd](https://github.com/facebook/zstd) (default).
 * **SHA256 hashes** for package metadata, files and binary packages.
 * Supports **package states** (ala dpkg) to mitigate broken package
   installs/updates.
 * Ability to **resume** partial package install/updates.
 * Ability to **unpack only files that have been modified** in package updates.
 * Ability to use **virtual packages**.
 * Ability to **ignore completely** any number of packages in dependency resolution.
 * Ability to **check for incompatible shared libraries in reverse
   dependencies**.
 * Ability to **update reverse dependencies** of any number of packages or **globally**
   in a single transaction.
 * Ability to **replace packages**.
 * Ability to **put packages on hold** (to never update them. NEW in 0.16).
 * Ability to **preserve/update configuration files**.
 * Ability to **force reinstallation** of any installed package.
 * Ability to **downgrade any** installed package.
 * Ability to **execute pre/post install/remove/update scriptlets**.
 * Ability to **check package integrity**: missing files, hashes, missing or
   unresolved (reverse)dependencies, dangling or modified symlinks, etc.

PS4 contains an almost complete test suite, currently with ~200 test cases,
and its number is growing daily! If you find any issue and you can reproduce it,
we will fix it and a new test case will be created. No more regressions!

PS4 is brought to you by:

- [Void linux team (main author)](https://github.com/void-linux/ps4)
- [TigerClips1](https://github.com/TigerClips1)
- [JaguarLinux](https://github.com/Jaguarlinux)

and many other contributors in the free community that have helped improving it.
See the `AUTHORS` file for a complete list of contributors.

Thanks to all who have contributed.

### Build requirements

To build this you'll need:

  - A C99 compiler (clang, gcc, pcc, tcc)
  - A POSIX compatible shell
  - [GNU make](https://www.gnu.org/software/make/)
  - [pkgconf](http://pkgconf.org/)
  - [zlib](https://www.zlib.net)
  - [openssl](https://www.openssl.org) or [libressl](https://www.libressl.org/)
  - [libarchive >= 3.3.3](https://www.libarchive.org) with lz4 and zstd support.

and optionally:

  - [graphviz](https://www.graphviz.org) and [doxygen](https://www.doxygen.org)
    (--enable-api-docs) to build API documentation.
  - [atf >= 0.15](https://github.com/jmmv/kyua) (--enable-tests) to build the
    Kyua test suite.

### Building and testing for dummies

```
$ git clone https://github.com/Jaguarlinux/JaguarLinux_Package_Manger
$ cd ps4
$ ./configure --enable-rpath --prefix=/usr --sysconfdir=/etc
$ make -j$(nproc)
$ make DESTDIR=~/ps4-git install clean
$ export PATH=~/ps4-git/usr/bin:$PATH
$ ps4-query -V
...
```

Thanks to `--enable-rpath` you can install it anywhere and it will still use
the libps4 shared library at `$ORIGIN/../lib`, that means that if ps4
is installed to `$HOME/ps4-git/usr`, the executables will use
`$HOME/ps4-git/usr/lib` to locate `libps4`.

Happy testing!

### Tests

To run the test suite make sure *kyua* is installed and run the following:

```
$ ./configure --enable-tests
$ make
$ make check
```

### Build instructions

Standard configure script (not generated by GNU autoconf).

```
$ ./configure --prefix=/blah
$ make -jX
$ make install
```

By default PREFIX is set `/usr/local` and may be changed by setting `--prefix`
in the `configure` script. The `DESTDIR` variable is also supported at the
install stage.

There are some more options that can be tweaked, see them with
`./configure --help`.

Good luck!

### Binaries

Binaries for Linux compiled statically with the musl C library are available:

* [x86\_64](https://mirror.ps4jaguarlinux.site/pub/)

These builds are available on all official void mirrors, along with their
*sha256* [checksums](https://mirror.ps4jaguarlinux.site/pub/sha256sums.txt).

### Usage instructions

The ps4 package includes the following utilities (among others, not a complete list):

 * `ps4-create (1)`      - PS4 utility to create binary packages
 * `ps4-dgraph (1)`      - PS4 utility to generate dot(1) graphs
 * `ps4-install (1)`     - PS4 utility to install and update packages
 * `ps4-pkgdb (1)`       - PS4 utility to report and fix issues in pkgdb
 * `ps4-query (1)`       - PS4 utility to query for package and repository information
 * `ps4-reconfigure (1)` - PS4 utility to configure installed packages
 * `ps4-remove (1)`      - PS4 utility to remove packages
 * `ps4-rindex (1)`      - PS4 utility to handle local binary package repositories

In the following sections there will be a brief description of how these utilities currently work.

### Package expressions

In the following examples there will be commands accepting an argument such as `<package expression>`. A package expression is a form to match a pattern; currently PS4 >= 0.19 supports 3 ways to specify them:

 * by specifying a package name, i.e `foo`.
 * by specifying the exact package name and version, i.e `foo-1.0_1`.
 * by specifying a package name and version separated by any of the following version comparators:
      * `<` less than
      * `>` greater than
      * `<=` less than or equal to
      * `>=` greater than or equal to

    Such example would be `foo>=2.0` or `blah-foo<=1.0`.

### Repositories

Repositories can be declared in a configuration file of the `configuration` or `system configuration` directories:

 * `<sysconfdir>/ps4.d` - The configuration directory (set to `/etc/ps4.d`)
 * `<sharedir>/ps4.d` - The system directory (set to `/usr/share/ps4.d`)

A configuration file bearing the same filename in `/etc/ps4.d` overrides the one from `<sharedir>/ps4.d`.
By default the `ps4` package provides only the main Void repository in the `/usr/share/ps4.d/00-repository-main.conf` file.

Additional repositories can be added by installing any of the following PS4 packages or creating new configuration files manually:

```
$ ps4-query -Rs void-repo
[*] jaguar-repo-debug-3_1            Jaguar Linux drop-in file for the debug repository
[*] jaguar-repo-multilib-3_1         Jaguar Linux drop-in file for the multilib repository
[*] jaguar-repo-multilib-nonfree-3_1 Jaguar Linux drop-in file for the multilib/nonfree repository
[*] jaguar-repo-nonfree-3_1          Jaguar Linux drop-in file for the nonfree repository
$
```

> Repositories specified in the `configuration` directory are added to the head of the list, while repositories specified via `system configuration` directories are appended to the existing list.

> If no repositories are found it's possible to declare them manually via the command line option `--repository`, currently accepted in `ps4-install(1)` and `ps4-query(1)`.

### ps4-query - querying packages and repositories

> ps4-query(1) will try to match `<package expression>` in local packages. This behaviour
can be changed by enabling the `-R` or `--repository` option to force repository mode.

To query the list of installed packages:

    $ ps4-query -l

To query the list of working repositories:

    $ ps4-query -L

To query the list of installed packages that were installed manually (not as dependencies):

    $ ps4-query -m

To query the list of packages on hold (won't be upgraded automatically):

    $ ps4-query -H

To query the list of installed package orphans (packages that were installed as dependencies but there is not any package currently that requires it):

    $ ps4-query -O

To query a package and show its meta information:

    $ ps4-query <package expression>

> Additionally the `-p or --property` option can be used to only show a specific key of a package:

    $ ps4-query --property=pkgver ps4
    ps4-0.19_1
    $

> Multiple properties can be specified by delimiting them with commas, i.e `-p key,key2`.

To query a package and show its file list:

    $ ps4-query -f <package expression>

To query a package and show required run-time dependencies:

    $ ps4-query -x <package expression>

To query a package and show required reverse run-time dependencies:

    $ ps4-query -X <package expression>

To query for packages matching a file with specified pattern(s) (ownedby mode):

    $ ps4-query -o <pattern>

> Where `<pattern>` is a shell wildcard pattern as explained in fnmatch(3); e.g `"*.png"`.

> Multiple `<patterns>` can be specified as arguments.

To query for packages matching pkgname/version/description with specified pattern(s) (search mode):

    $ ps4-query -s <pattern>

> The same rules explained above in the `ownedby` mode shall be applied.

### ps4-install - installing and updating packages

To synchronize remote repository index files:

    $ ps4-install -S

> The `-S, --sync` option can be combined while installing or updating packages, i.e `ps4-install -Su`.

To install a package:

    $ ps4-install <package expression>

To install multiple packages at once:

    $ ps4-install <package expression> <package expressions>

To update a single package:

    $ ps4-install -u <package expression>

To update all packages (also known as dist-upgrade in Debian/Ubuntu):

    $ ps4-install -u

> The `-n, --dry-run` option can be used to print what packages will be updated and/or installed and doesn't need permissions in the target rootdir, which can be useful to list updates.

### ps4-remove - removing packages

To remove a package:

    $ ps4-remove <package name>

To recursively remove unneeded dependencies that were installed by the target package:

    $ ps4-remove -R <package name>

To remove package orphans:

    $ ps4-remove -o

To clean the cache directory and remove outdated packages and/or packages with wrong hash:

    $ ps4-remove -O

> To remove package orphans and clean the cache repository both options can be combined, i.e `ps4-remove -Oo`.

### ps4-reconfigure - configure (or force configuration of) a package

The `ps4-reconfigure(1)` utility may be used to configure packages that were not previously
(perhaps due to a power outage, process killed, etc) or simply to force package
reconfiguration. By default and unless the `-f, --force` option is set, only packages that
were not configured will be processed.

Its usage is simple, specify a package name or `-a, --all` for all packages:

    $ ps4-reconfigure [-f] <package name> | -a

### ps4-pkgdb - checking for errors in packages and pkgdb

The `ps4-pkgdb(1)` utility may be used to check for errors in packages and in the package database.
It is also used to update the *package database* format (if there have been changes). It works exactly the
same way as `ps4-reconfigure(1)` and expects a package name or -a, --all for all packages.

    $ ps4-pkgdb <package name> | -a

To put a package on hold mode (won't be upgraded in dist-upgrade mode):

    $ ps4-pkgdb -m hold <package name>

To remove a package from hold mode:

    $ ps4-pkgdb -m unhold <package name>

To put a package in automatic mode (as it were installed as a dependency):

    $ ps4-pkgdb -m auto <package name>

To put a package in manual mode (won't be detected as orphan):

    $ ps4-pkgdb -m manual <package name>

To update the pkgdb format to the latest one:

    $ ps4-pkgdb -u

> NOTE: updating the pkgdb format does not happen too frequently, therefore it's only necessary in rare circumstances.

### ps4-rindex - Create, update and administer local repositories

This command only has 3 operation modes:

 * Add [-a, --all]: adds the specified packages into the specified repository and removes previous entry if found:

        $ ps4-rindex -a /path/to/repository/*.ps4

> The `-f, --force` option can be used to forcefully register a package into the repository index, even if the same version is already registered.

 * Clean [-c, --clean]: cleans the index of the specified repository by removing outdated or invalid entries (nonexistent packages, unmatched hashes, etc):

        $ ps4-rindex -c /path/to/repository

 * Remove-obsoletes [-r, --remove-obsoletes]: removes obsolete packages in repository (outdated, broken and unmatched hashes):

        $ ps4-rindex -r /path/to/repository

### Examples

Upgrade all packages in the system, without asking for an answer:

    # ps4-install -Syu

Clean the cache directory and remove package orphans:

    # ps4-remove -Oo

Show information of a package available in repositories:

    $ ps4-query -R ps4

Show filelist of a package available in repositories:

    $ ps4-query -Rf ps4

Find the packages that own the file `/bin/ls` in repositories:

    $ ps4-query -Ro /bin/ls

Make a package keepable (won't be detected as orphan):

    # ps4-pkgdb -m manual ps4

Search for packages in repositories matching the `ps4` pattern in its `pkgver` and `short_desc` objects:

    $ ps4-query -Rs ps4

Remove a package and all unnecessary dependencies that were installed:

    # ps4-remove -R xbmc

Appending repositories via command line:

    $ ps4-query --repository=<url> ...
    # ps4-install --repository=<url> ...

Switch an installed package to on *hold* mode (won't be updated via `ps4-install -u`):

    # ps4-pkgdb -m hold <pkgname>

Switch an installed package to the *unhold* mode (will be updated if there are updates):

    # ps4-pkgdb -m unhold <pkgname>

Check for errors on installed packages and in pkgdb:

    # ps4-pkgdb -a

Listing all files not managed by ps4:

```sh
#!/bin/sh

tmp=$(mktemp -dt ps4-disownedXXXXXX)
pkg=$tmp/pkg
fs=$tmp/fs

trap "rm -rf $tmp" EXIT

ps4-query -o \* | cut -d ' ' -f2 | sort > $pkg
find /boot /etc /opt /usr /var -xdev -type f -print | sort > $fs

comm -23 $fs $pkg
```
